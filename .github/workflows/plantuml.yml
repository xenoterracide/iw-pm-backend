name: PlantUML
on:
  push:
    paths:
    - '**.puml'
jobs:
  plantuml:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 1
    - uses: ts-graphviz/setup-graphviz@v1
    - run: git diff-tree -r --no-commit-id --name-only HEAD | grep '.puml' | xargs
    - run: git diff HEAD..HEAD~1
    - name: Get changed UML files
      id: getfile
      run: |
        echo "::set-output name=files::$(git diff-tree -r --no-commit-id --name-only HEAD | grep '.puml' | xargs)"
    - name: UML files considered echo output
      run: |
        echo ${{ steps.getfile.outputs.files }}
    - uses: actions/cache@v2
      with:
        path: plantuml.jar
        key: ${{ runner.os }}-${{ hashFiles('plantuml.jar') }}
    - run: wget -N --no-verbose https://downloads.sourceforge.net/project/plantuml/plantuml.jar
    - run: java -jar plantuml.jar -v -tsvg ${{ steps.getfile.outputs.files }}
    - uses: EndBug/add-and-commit@v7
      with:
        message: 'generate SVG for PlantUML'
        add: '*.svg'
